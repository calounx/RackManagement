# Alembic Setup for HomeRack Backend

This document describes the Alembic database migration setup for the HomeRack backend.

## Overview

Alembic has been initialized and configured to work with the existing SQLAlchemy setup in this project. The configuration allows for database schema version control and migrations.

## Directory Structure

```
backend/
├── alembic/                  # Alembic migration directory
│   ├── versions/             # Migration scripts go here
│   ├── env.py               # Alembic environment configuration
│   ├── script.py.mako       # Template for new migration scripts
│   └── README               # Alembic usage instructions
├── alembic.ini              # Alembic configuration file
└── app/
    ├── database.py          # SQLAlchemy Base and engine
    └── models.py            # Database models
```

## Configuration Details

### alembic.ini
- Configured to use SQLite database: `sqlite:///./homerack.db`
- Database URL is overridden in `env.py` to use the same configuration as the application
- Script location points to the `alembic` directory
- Standard logging configuration

### env.py
The environment file has been configured to:
1. Add the backend directory to Python path for imports
2. Import the SQLAlchemy `Base` from `app.database`
3. Import all models from `app.models`:
   - DeviceSpecification
   - Device
   - Rack
   - RackPosition
   - Connection
4. Use the `SQLALCHEMY_DATABASE_URL` from `app.database` (respects environment variables)
5. Set `target_metadata = Base.metadata` for autogenerate support

## Database Configuration

The database URL is determined by:
1. First checking the `DATABASE_URL` environment variable
2. Falling back to `sqlite:///./homerack.db` if not set

This matches the configuration in `app/database.py`, ensuring consistency.

## Available Models

The following models are registered and available for migrations:
- `device_specifications` - Device specification lookup database
- `devices` - User's actual device instances
- `racks` - Network rack configurations
- `rack_positions` - Device positions in racks
- `connections` - Connections between devices

## Usage

### Prerequisites

Install Alembic (if not already installed):
```bash
pip install alembic==1.13.1
# OR on Debian/Ubuntu:
sudo apt-get install python3-alembic
```

### Common Commands

**Check current revision:**
```bash
python3 -m alembic current
```

**Generate a new migration (autogenerate):**
```bash
python3 -m alembic revision --autogenerate -m "Description of changes"
```

**Apply migrations:**
```bash
python3 -m alembic upgrade head
```

**Downgrade one revision:**
```bash
python3 -m alembic downgrade -1
```

**Show migration history:**
```bash
python3 -m alembic history
```

**Show migration branches:**
```bash
python3 -m alembic branches
```

**Mark current database state without running migrations:**
```bash
python3 -m alembic stamp head
```

### Creating Your First Migration

If you have an existing database created with `init_db.py`, you should stamp it first:

```bash
# Option 1: If database already exists with schema
python3 -m alembic revision -m "Initial schema"
# Then manually edit the migration to match your current schema
# Or just stamp it as the initial state:
python3 -m alembic stamp head

# Option 2: Start fresh with migrations
rm homerack.db  # Remove existing database
python3 -m alembic revision --autogenerate -m "Initial schema"
python3 -m alembic upgrade head
```

### Workflow for Schema Changes

1. Modify your models in `app/models.py`
2. Generate a migration:
   ```bash
   python3 -m alembic revision --autogenerate -m "Add new column to devices"
   ```
3. Review the generated migration in `alembic/versions/`
4. Apply the migration:
   ```bash
   python3 -m alembic upgrade head
   ```

## Important Notes

### Always Review Autogenerated Migrations
Alembic's autogenerate feature is helpful but not perfect. Always review generated migrations before applying them, especially for:
- Index changes
- Constraint changes
- Column type changes
- Data migrations

### Testing Migrations
- Test migrations in a development environment first
- Test both upgrade and downgrade paths
- Backup your database before running migrations in production

### Version Control
- Keep all migration files in version control
- Never edit applied migrations - create new ones instead
- Migration files should be included in git commits

### Environment Variables
The setup respects the `DATABASE_URL` environment variable, allowing different database configurations for:
- Development: SQLite (`sqlite:///./homerack.db`)
- Production: PostgreSQL or other databases

Example:
```bash
export DATABASE_URL="postgresql://user:pass@localhost/homerack"
python3 -m alembic upgrade head
```

## Troubleshooting

### "No such file or directory: alembic"
Make sure you're running commands from the `backend` directory where `alembic.ini` is located.

### "ModuleNotFoundError: No module named 'app'"
The `env.py` adds the backend directory to the Python path. Make sure you're running from the correct directory.

### "Target database is not up to date"
Run `python3 -m alembic upgrade head` to apply pending migrations.

### Import Errors
If you add new models, make sure to import them in `env.py` so Alembic can detect them.

## Integration with Existing Database

If you already have a database created with `init_db.py`:

1. **Option A: Stamp existing database (recommended)**
   ```bash
   python3 -m alembic revision -m "Initial schema"
   # Edit the generated migration to include current schema
   python3 -m alembic stamp head
   ```

2. **Option B: Start fresh with Alembic**
   ```bash
   rm homerack.db
   python3 -m alembic revision --autogenerate -m "Initial schema"
   python3 -m alembic upgrade head
   ```

## Verification

To verify the setup is working:

```bash
# Check that Alembic can connect to the database
python3 -m alembic current

# Verify models are detected
python3 << EOF
import sys
sys.path.insert(0, '.')
from app.database import Base
from app.models import *
print(f"Detected tables: {list(Base.metadata.tables.keys())}")
EOF
```

Expected output:
```
Detected tables: ['device_specifications', 'devices', 'racks', 'rack_positions', 'connections']
```
