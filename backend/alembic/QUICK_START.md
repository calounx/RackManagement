# Alembic Quick Start Guide

## Setup Verification

Alembic has been successfully configured! Run this to verify:

```bash
python3 -m alembic current
```

You should see output indicating SQLite connection without errors.

## Quick Command Reference

### Check Current State
```bash
# Show current migration revision
python3 -m alembic current

# Show migration history
python3 -m alembic history

# Show migration branches (if any)
python3 -m alembic branches
```

### Create Migrations

```bash
# Auto-generate migration from model changes
python3 -m alembic revision --autogenerate -m "describe your changes"

# Create empty migration (for manual data migrations)
python3 -m alembic revision -m "describe your changes"
```

### Apply Migrations

```bash
# Upgrade to latest
python3 -m alembic upgrade head

# Upgrade one version
python3 -m alembic upgrade +1

# Downgrade one version
python3 -m alembic downgrade -1

# Downgrade to specific revision
python3 -m alembic downgrade <revision_id>
```

### Mark Database State

```bash
# Mark database as being at 'head' without running migrations
# Useful for existing databases
python3 -m alembic stamp head

# Mark specific revision
python3 -m alembic stamp <revision_id>
```

## Workflow Example

### Starting Fresh (No Database Yet)

```bash
# 1. Generate initial migration
python3 -m alembic revision --autogenerate -m "Initial schema"

# 2. Review the migration file in alembic/versions/

# 3. Apply the migration
python3 -m alembic upgrade head
```

### Existing Database (Created with init_db.py)

```bash
# Option A: Stamp existing database
python3 -m alembic revision --autogenerate -m "Initial schema"
python3 -m alembic stamp head

# Option B: Recreate with migrations
rm homerack.db
python3 -m alembic revision --autogenerate -m "Initial schema"
python3 -m alembic upgrade head
```

### Making Schema Changes

```bash
# 1. Edit models in app/models.py

# 2. Generate migration
python3 -m alembic revision --autogenerate -m "Add column X to table Y"

# 3. Review migration in alembic/versions/

# 4. Apply migration
python3 -m alembic upgrade head
```

## Important Notes

- **Always review autogenerated migrations** before applying
- **Test in development** before running in production
- **Migrations go in version control** - commit them to git
- **Never edit applied migrations** - create new ones instead
- Run commands from `/home/calounx/repositories/homerack/backend/` directory

## Configuration

- Config file: `alembic.ini`
- Environment: `alembic/env.py`
- Migrations: `alembic/versions/`
- Database: Configured via `app/database.py` (respects `DATABASE_URL` env var)

## Current Setup

Models registered for migrations:
- `device_specifications` (19 columns)
- `devices` (7 columns)
- `racks` (13 columns)
- `rack_positions` (5 columns)
- `connections` (9 columns)

All models are automatically imported from `app/models.py` in `env.py`.
